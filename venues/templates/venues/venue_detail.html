{% extends 'base.html' %}
{% load static %}
{% load venue_extras %}

{% block title %}{{ venue.name }} - EventEase{% endblock %}

{% block content %}
<div class="container">
  <div class="venue-detail">
    <!-- Header -->
    <div class="venue-header">
      <div class="breadcrumb">
        <a href="{% url 'venues:venue_list' %}">Venues</a> > {{ venue.name }}
      </div>
      <h1>{{ venue.name }}</h1>
      <div class="venue-type">{{ venue.get_venue_type_display }}</div>
    </div>

    <!-- Main Content -->
    <div class="venue-content">
      <!-- Image Gallery -->
      <div class="venue-images">
        {% if venue.images.exists or venue.main_image %}
        <div class="image-slideshow">
          <div class="slideshow-container">
            {% if venue.images.exists %}
            {% for image in venue.images.all %}
            <div class="slide {% if forloop.first %}active{% endif %}">
              <img
                src="{{ image.image.url }}"
                alt="{{ venue.name }} - Image {{ forloop.counter }}"
              />
              {% if image.caption %}
              <div class="slide-caption">{{ image.caption }}</div>
              {% endif %}
            </div>
            {% endfor %}
            {% elif venue.main_image %}
            <div class="slide active">
              <img src="{{ venue.main_image.url }}" alt="{{ venue.name }}" />
            </div>
            {% endif %}

            <!-- Navigation arrows (only show if multiple images) -->
            {% if venue.images.count > 1 %}
            <button class="slideshow-btn prev" onclick="changeSlide(-1)">
              ❮
            </button>
            <button class="slideshow-btn next" onclick="changeSlide(1)">
              ❯
            </button>
            {% endif %}
          </div>

          <!-- Thumbnail navigation (only show if multiple images) -->
          {% if venue.images.count > 1 %}
          <div class="thumbnail-nav">
            {% for image in venue.images.all %}
            <img
              src="{{ image.image.url }}"
              alt="Thumbnail {{ forloop.counter }}"
              class="thumbnail {% if forloop.first %}active{% endif %}"
              onclick="currentSlide({{ forloop.counter }})"
            />
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% else %}
        <img
          src="https://images.unsplash.com/photo-1540574163026-643ea20ade25?auto=format&fit=crop&w=800&q=80"
          alt="{{ venue.name }}"
          class="main-image"
        />
        {% endif %}
      </div>

      <!-- Venue Info -->
      <div class="venue-info">
        <div class="info-section">
          <h2>About This Venue</h2>
          <p class="description">{{ venue.description }}</p>

          <!-- Venue Rating Section -->
          {% if venue.review_count > 0 %}
          <div class="venue-rating-section">
            <div class="rating-display">
              <div class="overall-rating">
                <span class="rating-score">{{ venue.average_rating|floatformat:1 }}</span>
                <div class="rating-stars">
                  {% for i in "12345" %}
                    {% if forloop.counter <= venue.average_rating %}
                      <i class="fas fa-star"></i>
                    {% elif forloop.counter|add:"-1" < venue.average_rating %}
                      <i class="fas fa-star-half-alt"></i>
                    {% else %}
                      <i class="far fa-star"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <span class="rating-count">{{ venue.review_count }} review{{ venue.review_count|pluralize }}</span>
              </div>
              
              <div class="category-ratings-preview">
                {% with venue.category_averages as cats %}
                  <div class="category-rating-item">
                    <span class="category-name">Ambience</span>
                    <span class="category-score">{{ cats.ambience|floatformat:1 }}</span>
                  </div>
                  <div class="category-rating-item">
                    <span class="category-name">Service</span>
                    <span class="category-score">{{ cats.service|floatformat:1 }}</span>
                  </div>
                  <div class="category-rating-item">
                    <span class="category-name">Cleanliness</span>
                    <span class="category-score">{{ cats.cleanliness|floatformat:1 }}</span>
                  </div>
                  <div class="category-rating-item">
                    <span class="category-name">Value</span>
                    <span class="category-score">{{ cats.value|floatformat:1 }}</span>
                  </div>
                {% endwith %}
              </div>
              
              <div class="rating-actions">
                <a href="{% url 'reviews:venue_reviews' venue.id %}" class="view-reviews-btn">
                  <i class="fas fa-star"></i> View All Reviews
                </a>
                {% if user_venue_review %}
                  <a href="{% url 'reviews:submit_venue_review' venue.id %}" class="edit-review-btn">
                    <i class="fas fa-edit"></i> Edit Your Review
                  </a>
                {% elif user_can_review_venue %}
                  <a href="{% url 'reviews:submit_venue_review' venue.id %}" class="add-review-btn">
                    <i class="fas fa-plus"></i> Write a Review
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
          {% else %}
          <div class="venue-rating-section">
            <div class="no-ratings">
              <p><i class="fas fa-star"></i> No reviews yet - be the first to review this venue!</p>
              {% if user_can_review_venue %}
                <div style="text-align: center; margin-top: 1rem;">
                  <a href="{% url 'reviews:submit_venue_review' venue.id %}" class="add-review-btn">
                    <i class="fas fa-plus"></i> Write the First Review
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <div class="venue-details">
            <div class="detail-item">
              <span class="label">🏢 Venue Type:</span>
              <span class="value">{{ venue.get_venue_type_display }}</span>
            </div>
            <div class="detail-item">
              <span class="label">👥 Capacity:</span>
              <span class="value">{{ venue.capacity }} people</span>
            </div>
            <div class="detail-item">
              <span class="label">📍 Full Address:</span>
              <span class="value"
                >{{ venue.address }}, {{ venue.city }}, {{ venue.state }} {{
                venue.zipcode }}, {{ venue.country }}</span
              >
            </div>
            {% if venue.contact_email %}
            <div class="detail-item">
              <span class="label">📧 Contact Email:</span>
              <span class="value"
                ><a href="mailto:{{ venue.contact_email }}"
                  >{{ venue.contact_email }}</a
                ></span
              >
            </div>
            {% endif %}
            {% if venue.contact_phone %}
            <div class="detail-item">
              <span class="label">📞 Contact Phone:</span>
              <span class="value"
                ><a href="tel:{{ venue.contact_phone }}"
                  >{{ venue.contact_phone }}</a
                ></span
              >
            </div>
            {% endif %}
            {% if venue.website %}
            <div class="detail-item">
              <span class="label">🌐 Website:</span>
              <span class="value"
                ><a href="{{ venue.website }}" target="_blank" rel="noopener"
                  >{{ venue.website }}</a
                ></span
              >
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Booking Information -->
        <div class="info-section">
          <h2>Booking Information</h2>
          <div class="venue-details">
            <div class="detail-item">
              <span class="label">⏱️ Minimum Booking:</span>
              <span class="value"
                >{{ venue.min_booking_hours }} hour{{
                venue.min_booking_hours|pluralize }}</span
              >
            </div>
            <div class="detail-item">
              <span class="label">📅 Maximum Booking:</span>
              <span class="value"
                >{{ venue.max_booking_days }} day{{
                venue.max_booking_days|pluralize }}</span
              >
            </div>
            <div class="detail-item">
              <span class="label">✅ Availability:</span>
              <span class="value">
                {% if venue.is_available %}
                <span class="status available">Available for Booking</span>
                {% else %}
                <span class="status unavailable">Currently Unavailable</span>
                {% endif %}
              </span>
            </div>
          </div>
        </div>

        <!-- Amenities -->
        <div class="info-section">
          <h2>Amenities</h2>
          <div class="amenities-grid">
            <div
              class="amenity-item {% if venue.has_parking %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🅿️</span>
              <span class="text">Parking</span>
            </div>
            <div
              class="amenity-item {% if venue.has_wifi %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">📶</span>
              <span class="text">WiFi</span>
            </div>
            <div
              class="amenity-item {% if venue.has_catering %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🍽️</span>
              <span class="text">Catering</span>
            </div>
            <div
              class="amenity-item {% if venue.has_av_equipment %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🎵</span>
              <span class="text">A/V Equipment</span>
            </div>
            <div
              class="amenity-item {% if venue.has_stage %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🎭</span>
              <span class="text">Stage</span>
            </div>
            <div
              class="amenity-item {% if venue.has_bar %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🍷</span>
              <span class="text">Bar</span>
            </div>
            <div
              class="amenity-item {% if venue.has_kitchen %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">👨‍🍳</span>
              <span class="text">Kitchen</span>
            </div>
            <div
              class="amenity-item {% if venue.has_outdoor_space %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🌳</span>
              <span class="text">Outdoor Space</span>
            </div>
            <div
              class="amenity-item {% if venue.has_dance_floor %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">💃</span>
              <span class="text">Dance Floor</span>
            </div>
            <div
              class="amenity-item {% if venue.has_security %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🔒</span>
              <span class="text">Security</span>
            </div>
            <div
              class="amenity-item {% if venue.has_climate_control %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">🌡️</span>
              <span class="text">Climate Control</span>
            </div>
            <div
              class="amenity-item {% if venue.has_accessibility %}available{% else %}unavailable{% endif %}"
            >
              <span class="icon">♿</span>
              <span class="text">Accessibility</span>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="info-section">
          <h2>💰 Pricing</h2>
          <div class="pricing-info">
            {% if venue.price_per_hour %}
            <div class="price-item">
              <span class="price">${{ venue.price_per_hour }}</span>
              <span class="period">per hour</span>
            </div>
            {% endif %}
            {% if venue.price_per_day %}
            <div class="price-item">
              <span class="price">${{ venue.price_per_day }}</span>
              <span class="period">per day</span>
            </div>
            {% endif %}
            {% if not venue.price_per_hour and not venue.price_per_day %}
            <p class="contact-pricing">Contact venue for pricing details</p>
            {% endif %}
          </div>
        </div>

        {% if venue.rules_and_regulations %}
        <!-- Rules and Regulations -->
        <div class="info-section">
          <h2>📋 Rules and Regulations</h2>
          <div class="policy-content">
            {{ venue.rules_and_regulations|linebreaks }}
          </div>
        </div>
        {% endif %}
        {% if venue.cancellation_policy %}
        <!-- Cancellation Policy -->
        <div class="info-section">
          <h2>❌ Cancellation Policy</h2>
          <div class="policy-content">
            {{ venue.cancellation_policy|linebreaks }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="venue-actions">
      {% if user.is_authenticated %}
      {% if user.profile.role in 'admin,event_manager' %}
      <a
        href="{% url 'venues:venue_book' venue.pk %}"
        class="btn btn-primary btn-large"
      >
        📅 Book This Venue
      </a>
      {% endif %}
      {% if venue.manager == user or user.profile.role == 'admin' %}
      <a
        href="{% url 'venues:venue_edit' venue.pk %}"
        class="btn btn-secondary"
      >
        ✏️ Edit Venue
      </a>
      <a
        href="{% url 'venues:venue_delete' venue.pk %}"
        class="btn btn-danger"
        onclick="return confirm('Are you sure you want to delete this venue?')"
      >
        🗑️ Delete Venue
      </a>
      {% endif %}
      {% else %}
      <p class="login-message">
        <a href="{% url 'users:login' %}">Login</a> to book this venue
      </p>
      {% endif %}

      <a href="{% url 'venues:venue_list' %}" class="btn btn-outline">
        ← Back to Venues
      </a>
    </div>

    <!-- Manager Info -->
    <div class="manager-info">
      <h3>Venue Manager</h3>
      <div class="manager-card">
        <div class="manager-avatar">
          {% if venue.manager.profile.avatar %}
          <img
            src="{{ venue.manager.profile.avatar.url }}"
            alt="{{ venue.manager.get_full_name }}"
          />
          {% else %}
          <div class="avatar-placeholder">
            {{ venue.manager.first_name|first }}{{ venue.manager.last_name|first
            }}
          </div>
          {% endif %}
        </div>
        <div class="manager-details">
          <h4>
            <a
              href="{% url 'users:view_user_profile' venue.manager.id %}"
              class="manager-name-link"
              >{{ venue.manager.get_full_name }}</a
            >
          </h4>
          <p>{{ venue.manager.profile.get_role_display }}</p>
          {% if venue.manager.profile.bio %}
          <p class="bio">{{ venue.manager.profile.bio|truncatewords:20 }}</p>
          {% endif %}
          <p class="manager-contact">
            <small
              >📧
              <a href="mailto:{{ venue.manager.email }}"
                >{{ venue.manager.email }}</a
              ></small
            >
          </p>
        </div>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h3>💬 Questions & Comments</h3>

      {% if user.is_authenticated %}
      <!-- Comment Form -->
      <div class="comment-form-container">
        <form method="post" enctype="multipart/form-data" class="comment-form">
          {% csrf_token %}
          <div class="form-group">
            {{ comment_form.comment }} {{ comment_form.parent_id }}
          </div>
          <div class="form-group image-upload-section">
            <label
              for="{{ comment_form.image.id_for_label }}"
              class="image-upload-label"
            >
              <span class="upload-icon">📷</span>
              <span class="upload-text">Attach Image</span>
              <span class="upload-optional">(Optional)</span>
            </label>
            <div class="file-input-wrapper">
              {{ comment_form.image }}
              <div class="file-input-overlay">
                <span class="file-icon">📁</span>
                <span class="file-text">Choose file or drag & drop</span>
              </div>
            </div>
            <small class="image-help-text">
              <span class="help-icon">ℹ️</span>
              {{ comment_form.image.help_text }}
            </small>
          </div>
          <button type="submit" class="btn btn-primary">Post Comment</button>
        </form>
      </div>
      {% else %}
      <div class="login-prompt">
        <p>
          <a href="{% url 'users:login' %}">Login</a> to ask questions or leave
          comments about this venue.
        </p>
      </div>
      {% endif %}

      <!-- Comments Display -->
      <div class="comments-container">
        {% for comment in comments %}
        <div class="comment-item" data-comment-id="{{ comment.id }}">
          <div class="comment-header">
            <div class="comment-user">
              {% if comment.user.profile.avatar %}
              <img
                src="{{ comment.user.profile.avatar.url }}"
                alt="{{ comment.user.get_full_name }}"
                class="comment-avatar"
              />
              {% else %}
              <div class="comment-avatar-placeholder">
                {{ comment.user.first_name|first }}{{
                comment.user.last_name|first }}
              </div>
              {% endif %}
              <div class="comment-user-info">
                <strong>{{ comment.user.get_full_name }}</strong>
                {% if comment.user.profile.role %}
                <span class="user-role"
                  >({{ comment.user.profile.get_role_display }})</span
                >
                {% endif %}
                <small class="comment-date"
                  >{{ comment.created_at|date:"M d, Y g:i A" }}</small
                >
              </div>
            </div>
          </div>
          <div class="comment-content">
            {{ comment.comment|linebreaks }} {% if comment.image %}
            <div class="comment-image">
              <img
                src="{{ comment.image.url }}"
                alt="Comment attachment"
                class="img-fluid comment-img"
                onclick="openImageModal('{{ comment.image.url }}')"
              />
            </div>
            {% endif %}
          </div>
          <div class="comment-actions">
            {% if user.is_authenticated %}
            <button
              type="button"
              class="btn-reply"
              onclick="showReplyForm({{ comment.id }})"
            >
              Reply
            </button>
            {% endif %}
            <button
              type="button"
              class="btn-like"
              id="like-btn-{{ comment.id }}"
              onclick="toggleLike({{ comment.id }})"
              data-liked="{% if comment|is_liked_by:user %}true{% else %}false{% endif %}"
            >
              <span class="like-icon" id="like-icon-{{ comment.id }}">
                {% if comment|is_liked_by:user %}❤️{% else %}🤍{% endif %}
              </span>
              <span class="like-count" id="like-count-{{ comment.id }}"
                >{{ comment.like_count }}</span
              >
            </button>
            {% if user.is_authenticated and comment.user == user or user.is_staff %}
            <button
              type="button"
              class="btn-delete"
              onclick="deleteComment({{ comment.id }}, 'venue')"
              title="Delete comment"
            >
              🗑️ Delete
            </button>
            {% endif %}
          </div>

          <!-- Reply Form (Hidden by default) -->
          {% if user.is_authenticated %}
          <div
            class="reply-form-container"
            id="reply-form-{{ comment.id }}"
            style="display: none"
          >
            <form
              method="post"
              enctype="multipart/form-data"
              class="reply-form"
            >
              {% csrf_token %}
              <input type="hidden" name="parent_id" value="{{ comment.id }}" />
              <div class="form-group">
                <textarea
                  name="comment"
                  class="form-control"
                  rows="2"
                  placeholder="Write a reply..."
                  required
                ></textarea>
              </div>
              <div class="form-group image-upload-section">
                <label class="image-upload-label">
                  <span class="upload-icon">📷</span>
                  <span class="upload-text">Attach Image</span>
                  <span class="upload-optional">(Optional)</span>
                </label>
                <div class="file-input-wrapper">
                  <input
                    type="file"
                    name="image"
                    class="form-control file-input"
                    accept="image/*"
                  />
                  <div class="file-input-overlay">
                    <span class="file-icon">📁</span>
                    <span class="file-text">Choose file</span>
                  </div>
                </div>
                <small class="image-help-text">
                  <span class="help-icon">ℹ️</span>
                  Optional: Upload an image (Max 5MB, JPG/PNG/GIF)
                </small>
              </div>
              <div class="reply-actions">
                <button type="submit" class="btn btn-sm btn-primary">
                  Post Reply
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  onclick="hideReplyForm({{ comment.id }})"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
          {% endif %}

          <!-- Replies -->
          {% if comment.replies.exists %}
          <div class="replies-container">
            {% for reply in comment.replies.all %}
            <div class="reply-item">
              <div class="comment-header">
                <div class="comment-user">
                  {% if reply.user.profile.avatar %}
                  <img
                    src="{{ reply.user.profile.avatar.url }}"
                    alt="{{ reply.user.get_full_name }}"
                    class="comment-avatar-small"
                  />
                  {% else %}
                  <div class="comment-avatar-placeholder-small">
                    {{ reply.user.first_name|first }}{{
                    reply.user.last_name|first }}
                  </div>
                  {% endif %}
                  <div class="comment-user-info">
                    <strong>{{ reply.user.get_full_name }}</strong>
                    {% if reply.user.profile.role %}
                    <span class="user-role"
                      >[{{ reply.user.profile.get_role_display }}]</span
                    >
                    {% endif %}
                    <small class="comment-date"
                      >{{ reply.created_at|date:"M d, Y g:i A" }}</small
                    >
                  </div>
                </div>
              </div>
              <div class="comment-content">
                {{ reply.comment|linebreaks }} {% if reply.image %}
                <div class="comment-image">
                  <img
                    src="{{ reply.image.url }}"
                    alt="Reply attachment"
                    class="img-fluid comment-img"
                    onclick="openImageModal('{{ reply.image.url }}')"
                  />
                </div>
                {% endif %}
              </div>

              <!-- Reply to Reply Actions -->
              <div class="comment-actions">
                {% if user.is_authenticated %}
                <button
                  type="button"
                  class="btn-reply"
                  onclick="showReplyForm({{ reply.id }})"
                >
                  Reply
                </button>
                {% endif %}
                <button
                  type="button"
                  class="btn-like"
                  id="like-btn-{{ reply.id }}"
                  onclick="toggleLike({{ reply.id }})"
                  data-liked="{% if reply|is_liked_by:user %}true{% else %}false{% endif %}"
                >
                  <span class="like-icon" id="like-icon-{{ reply.id }}">
                    {% if reply|is_liked_by:user %}❤️{% else %}🤍{% endif %}
                  </span>
                  <span class="like-count" id="like-count-{{ reply.id }}"
                    >{{ reply.like_count }}</span
                  >
                </button>
                {% if user.is_authenticated and reply.user == user or user.is_staff %}
                <button
                  type="button"
                  class="btn-delete"
                  onclick="deleteComment({{ reply.id }}, 'venue')"
                  title="Delete reply"
                >
                  🗑️ Delete
                </button>
                {% endif %}
              </div>

              <!-- Reply to Reply Form (Hidden by default) -->
              {% if user.is_authenticated %}
              <div
                class="reply-form-container nested-reply-form"
                id="reply-form-{{ reply.id }}"
                style="display: none"
              >
                <form method="post" class="reply-form">
                  {% csrf_token %}
                  <input
                    type="hidden"
                    name="parent_id"
                    value="{{ reply.id }}"
                  />
                  <div class="form-group">
                    <textarea
                      name="comment"
                      class="form-control"
                      rows="2"
                      placeholder="Write a reply to {{ reply.user.get_full_name }}..."
                      required
                    ></textarea>
                  </div>
                  <div class="reply-actions">
                    <button type="submit" class="btn btn-sm btn-primary">
                      Post Reply
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-secondary"
                      onclick="hideReplyForm({{ reply.id }})"
                    >
                      Cancel
                    </button>
                  </div>
                </form>
              </div>
              {% endif %}

              <!-- Nested Replies (Replies to Replies) -->
              {% if reply.replies.exists %}
              <div class="nested-replies-container">
                {% for nested_reply in reply.replies.all %}
                <div class="nested-reply-item">
                  <div class="comment-header">
                    <div class="comment-user">
                      {% if nested_reply.user.profile.avatar %}
                      <img
                        src="{{ nested_reply.user.profile.avatar.url }}"
                        alt="{{ nested_reply.user.get_full_name }}"
                        class="comment-avatar-small"
                      />
                      {% else %}
                      <div class="comment-avatar-placeholder-small">
                        {{ nested_reply.user.first_name|first }}{{
                        nested_reply.user.last_name|first }}
                      </div>
                      {% endif %}
                      <div class="comment-user-info">
                        <strong>{{ nested_reply.user.get_full_name }}</strong>
                        {% if nested_reply.user.profile.role %}
                        <span class="user-role"
                          >[{{ nested_reply.user.profile|role_designation }}]</span
                        >
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="comment-content">
                    {{ nested_reply.comment|linebreaks }}
                    {% if nested_reply.image %}
                    <div class="comment-image">
                      <img
                        src="{{ nested_reply.image.url }}"
                        alt="Nested reply attachment"
                        class="img-fluid comment-img"
                        onclick="openImageModal('{{ nested_reply.image.url }}')"
                      />
                    </div>
                    {% endif %}
                  </div>

                  <!-- Reply to Nested Reply Actions -->
                  <div class="comment-actions">
                    {% if user.is_authenticated %}
                    <button
                      type="button"
                      class="btn-reply"
                      onclick="showReplyForm({{ nested_reply.id }})"
                    >
                      Reply
                    </button>
                    {% endif %}
                    <button
                      type="button"
                      class="btn-like"
                      id="like-btn-{{ nested_reply.id }}"
                      onclick="toggleLike({{ nested_reply.id }})"
                      data-liked="{% if nested_reply|is_liked_by:user %}true{% else %}false{% endif %}"
                    >
                      <span
                        class="like-icon"
                        id="like-icon-{{ nested_reply.id }}"
                      >
                        {% if nested_reply|is_liked_by:user %}❤️{% else %}🤍{% endif %}
                      </span>
                      <span
                        class="like-count"
                        id="like-count-{{ nested_reply.id }}"
                        >{{ nested_reply.like_count }}</span
                      >
                    </button>
                    {% if user.is_authenticated and nested_reply.user == user or user.is_staff %}
                    <button
                      type="button"
                      class="btn-delete"
                      onclick="deleteComment({{ nested_reply.id }}, 'venue')"
                      title="Delete reply"
                    >
                      🗑️ Delete
                    </button>
                    {% endif %}
                  </div>

                  <!-- Reply to Nested Reply Form (Hidden by default) -->
                  {% if user.is_authenticated %}
                  <div
                    class="reply-form-container nested-reply-form deep-nested"
                    id="reply-form-{{ nested_reply.id }}"
                    style="display: none"
                  >
                    <form method="post" class="reply-form">
                      {% csrf_token %}
                      <input
                        type="hidden"
                        name="parent_id"
                        value="{{ nested_reply.id }}"
                      />
                      <div class="form-group">
                        <textarea
                          name="comment"
                          class="form-control"
                          rows="2"
                          placeholder="Write a reply to {{ nested_reply.user.get_full_name }}..."
                          required
                        ></textarea>
                      </div>
                      <div class="reply-actions">
                        <button type="submit" class="btn btn-sm btn-primary">
                          Post Reply
                        </button>
                        <button
                          type="button"
                          class="btn btn-sm btn-secondary"
                          onclick="hideReplyForm({{ nested_reply.id }})"
                        >
                          Cancel
                        </button>
                      </div>
                    </form>
                  </div>
                  {% endif %}

                  <!-- Deep Nested Replies (Replies to Nested Replies) -->
                  {% if nested_reply.replies.exists %}
                  <div class="deep-nested-replies-container">
                    {% for deep_reply in nested_reply.replies.all %}
                    <div class="deep-nested-reply-item">
                      <div class="comment-header">
                        <div class="comment-user">
                          {% if deep_reply.user.profile.avatar %}
                          <img
                            src="{{ deep_reply.user.profile.avatar.url }}"
                            alt="{{ deep_reply.user.get_full_name }}"
                            class="comment-avatar-small"
                          />
                          {% else %}
                          <div class="comment-avatar-placeholder-small">
                            {{ deep_reply.user.first_name|first }}{{
                            deep_reply.user.last_name|first }}
                          </div>
                          {% endif %}
                          <div class="comment-user-info">
                            <strong>{{ deep_reply.user.get_full_name }}</strong>
                            {% if deep_reply.user.profile.role %}
                            <span class="user-role"
                              >[{{ deep_reply.user.profile|role_designation }}]</span
                            >
                            {% endif %}
                            <small class="comment-date"
                              >{{ deep_reply.created_at|date:"M d, Y g:i A"
                              }}</small
                            >
                          </div>
                        </div>
                      </div>
                      <div class="comment-content">
                        {{ deep_reply.comment|linebreaks }}
                        {% if deep_reply.image %}
                        <div class="comment-image">
                          <img
                            src="{{ deep_reply.image.url }}"
                            alt="Deep reply attachment"
                            class="img-fluid comment-img"
                            onclick="openImageModal('{{ deep_reply.image.url }}')"
                          />
                        </div>
                        {% endif %}
                      </div>
                      
                      <!-- Deep Nested Reply Actions (No Reply Button) -->
                      <div class="comment-actions">
                        <button
                          type="button"
                          class="btn-like"
                          id="like-btn-{{ deep_reply.id }}"
                          onclick="toggleLike({{ deep_reply.id }})"
                          data-liked="{% if deep_reply|is_liked_by:user %}true{% else %}false{% endif %}"
                        >
                          <span class="like-icon" id="like-icon-{{ deep_reply.id }}">
                            {% if deep_reply|is_liked_by:user %}❤️{% else %}🤍{% endif %}
                          </span>
                          <span class="like-count" id="like-count-{{ deep_reply.id }}"
                            >{{ deep_reply.like_count }}</span
                          >
                        </button>
                        {% if user.is_authenticated and deep_reply.user == user or user.is_staff %}
                        <button
                          type="button"
                          class="btn-delete"
                          onclick="deleteComment({{ deep_reply.id }}, 'venue')"
                          title="Delete reply"
                        >
                          🗑️ Delete
                        </button>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% empty %}
        <div class="no-comments">
          <p>
            No questions or comments yet. Be the first to ask about this venue!
          </p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="modalImage" />
  <div class="modal-caption" id="modalCaption"></div>
</div>

<style>
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
  }

  .venue-detail {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .venue-header {
    background: linear-gradient(135deg, #40b5ad 0%, #369691 100%);
    color: white;
    padding: 2rem;
  }

  .breadcrumb {
    margin-bottom: 1rem;
    opacity: 0.9;
  }

  .breadcrumb a {
    color: white;
    text-decoration: none;
  }

  .venue-header h1 {
    margin: 0 0 0.5rem 0;
    font-size: 2.5rem;
  }

  .venue-type {
    background: rgba(255, 255, 255, 0.2);
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
  }

  .venue-content {
    padding: 2rem;
  }

  .venue-images {
    margin-bottom: 2rem;
  }

  .main-image {
    width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* Slideshow Styles */
  .image-slideshow {
    position: relative;
    max-width: 100%;
    margin: auto;
  }

  .slideshow-container {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .slide {
    display: none;
    position: relative;
  }

  .slide.active {
    display: block;
  }

  .slide img {
    width: 100%;
    height: 400px;
    object-fit: cover;
  }

  .slide-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    color: white;
    padding: 2rem 1rem 1rem;
    font-size: 1rem;
  }

  .slideshow-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    padding: 16px 20px;
    cursor: pointer;
    font-size: 18px;
    border-radius: 0;
    transition: background-color 0.3s;
    z-index: 10;
  }

  .slideshow-btn:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .slideshow-btn.prev {
    left: 0;
  }

  .slideshow-btn.next {
    right: 0;
  }

  .thumbnail-nav {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .thumbnail {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.3s;
    border: 2px solid transparent;
  }

  .thumbnail:hover,
  .thumbnail.active {
    opacity: 1;
    border-color: #40b5ad;
  }

  .venue-info .info-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e1e8ed;
  }

  .venue-info .info-section:last-child {
    border-bottom: none;
  }

  .venue-info h2 {
    color: #333;
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
  }

  .description {
    color: #666;
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .venue-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .detail-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }

  .detail-item .label {
    font-weight: 600;
    color: #333;
    min-width: 120px;
  }

  .detail-item .value {
    color: #666;
  }

  /* Venue Rating Styles */
  .venue-rating-section {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 15px;
    border: 1px solid #e0e0e0;
  }

  .rating-display {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .overall-rating {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .rating-score {
    font-size: 2rem;
    font-weight: bold;
    color: #40B5AD;
    min-width: 3rem;
    text-align: center;
  }

  .rating-stars {
    color: #ffd700;
    font-size: 1.5rem;
  }

  .rating-count {
    font-size: 0.9rem;
    color: #666;
    margin-left: auto;
  }

  .category-ratings-preview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
  }

  .category-rating-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    border-left: 3px solid #40B5AD;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .category-name {
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
  }

  .category-score {
    font-weight: bold;
    color: #40B5AD;
  }

  .rating-actions {
    text-align: center;
    margin-top: 1rem;
  }

  .view-reviews-btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #40B5AD 0%, #34a39a 100%);
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(64, 181, 173, 0.3);
  }

  .view-reviews-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(64, 181, 173, 0.4);
    color: white;
    text-decoration: none;
  }

  .add-review-btn, .edit-review-btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    margin-left: 1rem;
  }

  .edit-review-btn {
    background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
  }

  .add-review-btn:hover, .edit-review-btn:hover {
    transform: translateY(-2px);
    color: white;
    text-decoration: none;
  }

  .add-review-btn:hover {
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
  }

  .edit-review-btn:hover {
    box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
  }

  .no-ratings {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .no-ratings i {
    color: #40B5AD;
    margin-right: 0.5rem;
  }
    flex: 1;
  }

  .detail-item .value a {
    color: #40b5ad;
    text-decoration: none;
  }

  .detail-item .value a:hover {
    text-decoration: underline;
  }

  .amenities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .amenity-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: 8px;
    border: 2px solid;
    transition: all 0.2s;
  }

  .amenity-item.available {
    background: #e8f5e8;
    border-color: #27ae60;
    color: #27ae60;
  }

  .amenity-item.unavailable {
    background: #f8f9fa;
    border-color: #e1e8ed;
    color: #999;
    opacity: 0.6;
  }

  .amenity-item .icon {
    font-size: 1.2rem;
  }

  .amenity-item .text {
    font-weight: 600;
  }

  .pricing-info {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .price-item {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    border: 2px solid #e1e8ed;
  }

  .price-item .price {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: #40b5ad;
    margin-bottom: 0.25rem;
  }

  .price-item .period {
    color: #666;
    font-weight: 600;
  }

  .contact-pricing {
    color: #666;
    font-style: italic;
    margin: 0;
  }

  .venue-actions {
    display: flex;
    gap: 1rem;
    padding: 2rem;
    background: #f8f9fa;
    flex-wrap: wrap;
    justify-content: center;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-large {
    padding: 1rem 2rem;
    font-size: 1.1rem;
  }

  .btn-primary {
    background: #40b5ad;
    color: white;
  }

  .btn-primary:hover {
    background: #369691;
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #545b62;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-danger:hover {
    background: #c82333;
  }

  .btn-outline {
    background: transparent;
    color: #40b5ad;
    border: 2px solid #40b5ad;
  }

  .btn-outline:hover {
    background: #40b5ad;
    color: white;
  }

  .login-message {
    color: #666;
    margin: 0;
    text-align: center;
  }

  .login-message a {
    color: #40b5ad;
    text-decoration: none;
    font-weight: 600;
  }

  .manager-info {
    padding: 2rem;
    border-top: 1px solid #e1e8ed;
    background: #f8f9fa;
  }

  .manager-info h3 {
    color: #333;
    margin: 0 0 1rem 0;
    font-size: 1.3rem;
  }

  .manager-card {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .manager-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
  }

  .manager-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-placeholder {
    width: 100%;
    height: 100%;
    background: #40b5ad;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
  }

  .manager-details h4 {
    margin: 0 0 0.25rem 0;
    color: #333;
  }

  .manager-details p {
    margin: 0.25rem 0;
    color: #666;
    font-size: 0.9rem;
  }

  .manager-details .bio {
    margin-top: 0.5rem;
    line-height: 1.4;
  }

  /* New styles for additional venue information */
  .manager-name-link {
    color: #40b5ad;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .manager-name-link:hover {
    color: #369691;
    text-decoration: underline;
  }

  .manager-contact {
    margin-top: 0.5rem;
  }

  .manager-contact a {
    color: #40b5ad;
    text-decoration: none;
  }

  .manager-contact a:hover {
    text-decoration: underline;
  }

  .policy-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #40b5ad;
    line-height: 1.6;
    color: #555;
  }

  .status.available {
    color: #28a745;
    font-weight: 600;
  }

  .status.unavailable {
    color: #dc3545;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .venue-header h1 {
      font-size: 2rem;
    }

    .venue-content {
      padding: 1rem;
    }

    .main-image {
      height: 250px;
    }

    .amenities-grid {
      grid-template-columns: 1fr;
    }

    .pricing-info {
      justify-content: center;
    }

    .venue-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .venue-actions .btn {
      justify-content: center;
    }

    .manager-card {
      flex-direction: column;
      text-align: center;
    }
  }

  /* Dark Mode Styles for Venue Detail */
  body.dark-mode .container {
    background: #232728;
  }

  body.dark-mode .venue-detail {
    background: #232728;
  }

  body.dark-mode .venue-header {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .breadcrumb {
    color: #b0b0b0;
  }

  body.dark-mode .breadcrumb a {
    color: #40b5ad;
  }

  body.dark-mode .venue-header h1 {
    color: #40b5ad;
  }

  body.dark-mode .venue-type {
    background: #40b5ad;
    color: #232728;
  }

  body.dark-mode .venue-content {
    background: #232728;
  }

  body.dark-mode .venue-images {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .slideshow-container {
    background: #1a2f2e;
  }

  body.dark-mode .slide {
    background: #1a2f2e;
  }

  body.dark-mode .slide-caption {
    background: rgba(26, 47, 46, 0.9);
    color: #e0e0e0;
  }

  body.dark-mode .slideshow-btn {
    background: rgba(64, 181, 173, 0.8);
    color: #232728;
  }

  body.dark-mode .slideshow-btn:hover {
    background: #40b5ad;
  }

  body.dark-mode .thumbnail-nav {
    background: #2d3233;
  }

  body.dark-mode .thumbnail {
    border: 2px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .thumbnail.active {
    border-color: #40b5ad;
  }

  body.dark-mode .venue-info {
    background: #232728;
  }

  body.dark-mode .info-section {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .info-section h2 {
    color: #40b5ad;
    border-bottom-color: #40b5ad;
  }

  body.dark-mode .description {
    color: #e0e0e0;
  }

  body.dark-mode .venue-details {
    background: #232728;
  }

  body.dark-mode .detail-item {
    border-bottom: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .detail-item:last-child {
    border-bottom: none;
  }

  body.dark-mode .detail-item .label {
    color: #40b5ad;
  }

  body.dark-mode .detail-item .value {
    color: #e0e0e0;
  }

  body.dark-mode .detail-item .value a {
    color: #40b5ad;
  }

  body.dark-mode .detail-item .value a:hover {
    color: #2e837e;
  }

  body.dark-mode .status.available {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
  }

  body.dark-mode .status.unavailable {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
  }

  body.dark-mode .amenities-grid {
    background: #232728;
  }

  body.dark-mode .amenity-item {
    background: #2d3233;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .amenity-item.available {
    background: #1a2f2e;
    border-color: #40b5ad;
  }

  body.dark-mode .amenity-item.available .text {
    color: #40b5ad;
  }

  body.dark-mode .amenity-item.unavailable {
    background: #2d3233;
    border-color: rgba(108, 117, 125, 0.3);
  }

  body.dark-mode .amenity-item.unavailable .text {
    color: #6c757d;
  }

  body.dark-mode .pricing-info {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .price-item {
    background: #2d3233;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .price {
    color: #40b5ad;
  }

  body.dark-mode .period {
    color: #b0b0b0;
  }

  body.dark-mode .contact-pricing {
    color: #b0b0b0;
  }

  body.dark-mode .special-features {
    background: #232728;
  }

  body.dark-mode .special-features h3 {
    color: #40b5ad;
  }

  body.dark-mode .feature-item {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .feature-item h4 {
    color: #40b5ad;
  }

  body.dark-mode .feature-item p {
    color: #e0e0e0;
  }

  body.dark-mode .events-section {
    background: #232728;
  }

  body.dark-mode .events-section h2 {
    color: #40b5ad;
  }

  body.dark-mode .event-card {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .event-card:hover {
    background: #1e3635;
  }

  body.dark-mode .event-card h3 {
    color: #40b5ad;
  }

  body.dark-mode .event-card .event-meta {
    color: #b0b0b0;
  }

  body.dark-mode .event-card .event-description {
    color: #e0e0e0;
  }

  body.dark-mode .manager-section {
    background: #1a2f2e;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .manager-section h2 {
    color: #40b5ad;
  }

  body.dark-mode .manager-card {
    background: #2d3233;
    border: 1px solid rgba(64, 181, 173, 0.3);
  }

  body.dark-mode .manager-avatar {
    border: 2px solid #40b5ad;
  }

  body.dark-mode .avatar-placeholder {
    background: #40b5ad;
    color: #232728;
  }

  body.dark-mode .manager-info h3 {
    color: #40b5ad;
  }

  body.dark-mode .manager-info .role {
    background: #40b5ad;
    color: #232728;
  }

  body.dark-mode .contact-info {
    color: #e0e0e0;
  }

  body.dark-mode .contact-info a {
    color: #40b5ad;
  }

  body.dark-mode .contact-info a:hover {
    color: #2e837e;
  }

  body.dark-mode .btn-primary {
    background: linear-gradient(135deg, #40b5ad 0%, #369691 100%);
    color: #232728;
    border: 1px solid #40b5ad;
  }

  body.dark-mode .btn-primary:hover {
    background: linear-gradient(135deg, #2e837e 0%, #2a7671 100%);
    color: #ffffff;
  }

  body.dark-mode .btn-secondary {
    background: #6c757d;
    color: white;
    border: 1px solid #6c757d;
  }

  body.dark-mode .btn-secondary:hover {
    background: #5a6268;
  }

  /* Comments Section Styles */
  .comments-section {
    margin-top: 2rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 12px;
  }

  .comments-section h3 {
    color: #40b5ad;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
  }

  .comment-form-container {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .comment-form .form-group {
    margin-bottom: 1rem;
  }

  .comment-form textarea {
    width: 100%;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    font-family: inherit;
    transition: border-color 0.3s ease;
  }

  .comment-form textarea:focus {
    outline: none;
    border-color: #40b5ad;
    box-shadow: 0 0 0 3px rgba(64, 181, 173, 0.1);
  }

  .login-prompt {
    text-align: center;
    padding: 2rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .login-prompt a {
    color: #40b5ad;
    text-decoration: none;
    font-weight: 500;
  }

  .comments-container {
    space-y: 1.5rem;
  }

  .comment-item {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #40b5ad;
  }

  .comment-header {
    margin-bottom: 1rem;
  }

  .comment-user {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .comment-avatar-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #40b5ad;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .comment-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
  }

  .comment-avatar-placeholder-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8rem;
  }

  .comment-user-info strong {
    color: #333;
    font-size: 0.95rem;
  }

  .user-role {
    color: #6c757d;
    font-size: 0.85rem;
    font-weight: normal;
    margin-left: 0.5rem;
  }

  .comment-date {
    color: #6c757d;
    font-size: 0.8rem;
    display: block;
    margin-top: 0.25rem;
  }

  .comment-content {
    color: #555;
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .comment-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-reply {
    background: none;
    border: none;
    color: #40b5ad;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }

  .btn-reply:hover {
    background-color: rgba(64, 181, 173, 0.1);
  }

  .btn-like {
    background: none;
    border: none;
    color: #666;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .btn-like:hover {
    background-color: rgba(255, 105, 135, 0.1);
    color: #ff6987;
  }

  .btn-like.liked {
    color: #ff6987;
  }

  .like-icon {
    font-size: 1rem;
    transition: transform 0.2s ease;
  }

  .btn-like:hover .like-icon {
    transform: scale(1.2);
  }

  .like-count {
    font-size: 0.8rem;
    font-weight: 500;
  }

  .btn-delete {
    background: none;
    border: none;
    color: #dc3545;
    font-size: 0.75rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    opacity: 0.8;
  }

  .btn-delete:hover {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
    opacity: 1;
    transform: translateY(-1px);
  }

  .reply-form-container {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
  }

  .reply-form .form-group {
    margin-bottom: 0.75rem;
  }

  .reply-form textarea {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px;
    font-size: 0.9rem;
  }

  .reply-actions {
    display: flex;
    gap: 0.5rem;
  }

  .replies-container {
    margin-top: 1rem;
    padding-left: 2rem;
    border-left: 3px solid #e9ecef;
  }

  .reply-item {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
    border-left: 3px solid #6c757d;
  }

  /* Nested replies styles */
  .nested-replies-container {
    margin-top: 1rem;
    padding-left: 1.5rem;
    border-left: 2px solid #dee2e6;
  }

  .nested-reply-item {
    background: #f1f3f4;
    border-radius: 6px;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-left: 2px solid #40b5ad;
  }

  .nested-reply-form {
    background: #f1f3f4;
    border: 1px solid #dee2e6;
  }

  /* Deep nested replies styles */
  .deep-nested-replies-container {
    margin-top: 0.8rem;
    padding-left: 1rem;
    border-left: 2px solid #ced4da;
  }

  .deep-nested-reply-item {
    background: #e9ecef;
    border-radius: 4px;
    padding: 0.7rem;
    margin-bottom: 0.7rem;
    border-left: 2px solid #6c757d;
  }

  .deep-nested {
    background: #e9ecef;
    border: 1px solid #ced4da;
  }

  .no-comments {
    text-align: center;
    padding: 3rem 2rem;
    color: #6c757d;
    background: white;
    border-radius: 8px;
  }

  /* Comment Image Styles */
  .comment-image {
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .comment-img {
    max-width: 300px;
    max-height: 200px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .comment-img:hover {
    transform: scale(1.02);
  }

  /* Image Upload Section Styles */
  .image-upload-section {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
  }

  .image-upload-section:hover {
    border-color: #40b5ad;
    background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(64, 181, 173, 0.15);
  }

  .image-upload-label {
    display: flex;
    align-items: center;
    margin-bottom: 0.8rem;
    font-weight: 600;
    color: #495057;
    cursor: pointer;
  }

  .upload-icon {
    font-size: 1.2rem;
    margin-right: 0.5rem;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
  }

  .upload-text {
    font-size: 0.95rem;
    margin-right: 0.5rem;
  }

  .upload-optional {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 400;
    font-style: italic;
  }

  .file-input-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 0.8rem;
  }

  .file-input-wrapper .form-control,
  .file-input {
    position: relative;
    z-index: 2;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 1rem;
    font-size: 0.9rem;
  }

  .file-input-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 1;
  }

  .file-input-wrapper:hover .file-input-overlay {
    border-color: #40b5ad;
    background: #f8fdfc;
  }

  .file-icon {
    font-size: 1.1rem;
    opacity: 0.7;
  }

  .file-text {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .image-help-text {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: #6c757d;
    font-size: 0.8rem;
    margin: 0;
    padding: 0.5rem 0.8rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    border-left: 3px solid #40b5ad;
  }

  .help-icon {
    font-size: 0.9rem;
    opacity: 0.8;
  }

  /* File input focus states */
  .file-input:focus + .file-input-overlay {
    border-color: #40b5ad;
    box-shadow: 0 0 0 0.2rem rgba(64, 181, 173, 0.25);
  }

  /* Dark mode styles for image upload */
  body.dark-mode .image-upload-section {
    background: linear-gradient(135deg, #2d3233 0%, #1a2f2e 100%);
    border-color: #444;
  }

  body.dark-mode .image-upload-section:hover {
    border-color: #40b5ad;
    background: linear-gradient(135deg, #1e3a39 0%, #0f2625 100%);
  }

  body.dark-mode .image-upload-label {
    color: #e0e0e0;
  }

  body.dark-mode .file-input-overlay {
    background: #232728;
    border-color: #444;
  }

  body.dark-mode .file-input-wrapper:hover .file-input-overlay {
    background: #2d3233;
    border-color: #40b5ad;
  }

  body.dark-mode .file-text {
    color: #adb5bd;
  }

  body.dark-mode .image-help-text {
    background: rgba(35, 39, 40, 0.8);
    color: #adb5bd;
  }

  /* Image Modal Styles */
  .image-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.9);
    cursor: pointer;
  }

  .modal-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
    animation: zoom 0.3s;
  }

  @keyframes zoom {
    from {
      transform: scale(0.7);
    }
    to {
      transform: scale(1);
    }
  }

  .close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
  }

  .close-modal:hover,
  .close-modal:focus {
    color: #bbb;
    text-decoration: none;
  }

  .modal-caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    height: 150px;
  }

  /* Dark mode styles for comments */
  body.dark-mode .comments-section {
    background: #1a2f2e;
  }

  body.dark-mode .comments-section h3 {
    color: #40b5ad;
    border-bottom-color: #444;
  }

  body.dark-mode .comment-form-container,
  body.dark-mode .comment-item,
  body.dark-mode .no-comments,
  body.dark-mode .login-prompt {
    background: #2d3233;
    color: #e0e0e0;
  }

  body.dark-mode .comment-form textarea,
  body.dark-mode .reply-form textarea {
    background: #232728;
    border-color: #444;
    color: #e0e0e0;
  }

  body.dark-mode .comment-form textarea:focus,
  body.dark-mode .reply-form textarea:focus {
    border-color: #40b5ad;
  }

  body.dark-mode .comment-user-info strong {
    color: #e0e0e0;
  }

  body.dark-mode .comment-content {
    color: #d0d0d0;
  }

  body.dark-mode .reply-form-container {
    background: #1a2f2e;
    border-color: #444;
  }

  body.dark-mode .reply-item {
    background: #1a2f2e;
    border-left-color: #40b5ad;
  }

  /* Dark mode nested replies */
  body.dark-mode .nested-reply-item {
    background: #232728;
    border-left-color: #40b5ad;
    color: #e0e0e0;
  }

  body.dark-mode .nested-reply-form {
    background: #232728;
    border-color: #444;
  }

  body.dark-mode .deep-nested-reply-item {
    background: #2d3233;
    border-left-color: #6c757d;
    color: #e0e0e0;
  }

  body.dark-mode .deep-nested {
    background: #2d3233;
    border-color: #444;
  }

  body.dark-mode .btn-reply {
    color: #40b5ad;
  }

  body.dark-mode .btn-reply:hover {
    background-color: rgba(64, 181, 173, 0.2);
  }

  body.dark-mode .btn-like {
    color: #bbb;
  }

  body.dark-mode .btn-like:hover {
    background-color: rgba(255, 105, 135, 0.2);
    color: #ff6987;
  }

  body.dark-mode .btn-like.liked {
    color: #ff6987;
  }
</style>

<script>
  let slideIndex = 1;

  function changeSlide(n) {
    showSlide((slideIndex += n));
  }

  function currentSlide(n) {
    showSlide((slideIndex = n));
  }

  function showSlide(n) {
    let slides = document.getElementsByClassName("slide");
    let thumbnails = document.getElementsByClassName("thumbnail");

    if (n > slides.length) {
      slideIndex = 1;
    }
    if (n < 1) {
      slideIndex = slides.length;
    }

    for (let i = 0; i < slides.length; i++) {
      slides[i].classList.remove("active");
    }

    for (let i = 0; i < thumbnails.length; i++) {
      thumbnails[i].classList.remove("active");
    }

    if (slides[slideIndex - 1]) {
      slides[slideIndex - 1].classList.add("active");
    }

    if (thumbnails[slideIndex - 1]) {
      thumbnails[slideIndex - 1].classList.add("active");
    }
  }

  // Keyboard navigation
  document.addEventListener("keydown", function (e) {
    if (e.key === "ArrowLeft") {
      changeSlide(-1);
    } else if (e.key === "ArrowRight") {
      changeSlide(1);
    }
  });

  // Comment reply functions
  function showReplyForm(commentId) {
    const replyForm = document.getElementById("reply-form-" + commentId);
    if (replyForm) {
      replyForm.style.display = "block";
      const textarea = replyForm.querySelector("textarea");
      if (textarea) {
        textarea.focus();
      }
    }
  }

  function hideReplyForm(commentId) {
    const replyForm = document.getElementById("reply-form-" + commentId);
    if (replyForm) {
      replyForm.style.display = "none";
      const textarea = replyForm.querySelector("textarea");
      if (textarea) {
        textarea.value = "";
      }
    }
  }

  // Image modal functions
  function openImageModal(imageSrc) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    modal.style.display = "block";
    modalImg.src = imageSrc;
  }

  function closeImageModal() {
    const modal = document.getElementById("imageModal");
    modal.style.display = "none";
  }

  // Close modal when clicking outside the image
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeImageModal();
    }
  });

  // Toggle like functionality
  function toggleLike(commentId) {
    const likeBtn = document.getElementById(`like-btn-${commentId}`);
    const likeIcon = document.getElementById(`like-icon-${commentId}`);
    const likeCount = document.getElementById(`like-count-${commentId}`);

    // Disable button during request
    likeBtn.disabled = true;

    fetch(`/venues/comment/${commentId}/like/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Update like count
          likeCount.textContent = data.like_count;

          // Update like button appearance
          if (data.is_liked) {
            likeIcon.textContent = "❤️";
            likeBtn.classList.add("liked");
            likeBtn.setAttribute("data-liked", "true");
          } else {
            likeIcon.textContent = "🤍";
            likeBtn.classList.remove("liked");
            likeBtn.setAttribute("data-liked", "false");
          }

          // Add animation effect
          likeIcon.style.transform = "scale(1.3)";
          setTimeout(() => {
            likeIcon.style.transform = "scale(1)";
          }, 200);
        } else {
          console.error("Error toggling like:", data.error);
          alert("Error: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Network error:", error);
        alert("Network error. Please try again.");
      })
      .finally(() => {
        // Re-enable button
        likeBtn.disabled = false;
      });
  }

  // Delete comment function
  function deleteComment(commentId, type) {
    if (!confirm('Are you sure you want to delete this comment? This action cannot be undone and will also delete all replies to this comment.')) {
      return;
    }
    
    const deleteUrl = type === 'venue' ? `/venues/comment/${commentId}/delete/` : `/events/comment/${commentId}/delete/`;
    
    fetch(deleteUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Remove the comment element from the DOM
        const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`)?.closest('.comment-item, .reply-item, .nested-reply-item, .deep-nested-reply-item');
        if (commentElement) {
          commentElement.style.opacity = '0.5';
          commentElement.style.transform = 'translateX(-20px)';
          setTimeout(() => {
            commentElement.remove();
          }, 300);
        }
        
        // Show success message
        const message = document.createElement('div');
        message.className = 'alert alert-success';
        message.style.position = 'fixed';
        message.style.top = '20px';
        message.style.right = '20px';
        message.style.zIndex = '9999';
        message.textContent = data.message;
        document.body.appendChild(message);
        
        setTimeout(() => {
          message.remove();
        }, 3000);
      } else {
        alert(data.error || 'Failed to delete comment');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to delete comment. Please try again.');
    });
  }
</script>
{% endblock %}
